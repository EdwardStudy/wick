#!/usr/bin/env bash

wickGetOption DYNAMIC dynamic "$@"
wickGetArgument DESIRED 0 "$@"

if [ -z "$DYNAMIC" ]; then
    wickInfo "Setting the hostname: $DESIRED"
    "$WICK_FORMULA_DIR/files/set-hostname" --verbose "$DESIRED"
else
    wickInfo "Setting a dynamic hostname: $DESIRED"
    wickMakeFile set-hostname /usr/local/bin/ --mode=0755

    HOOK_FILE="/etc/dhcp/dhclient-exit-hooks"
    wickInfo "Creating/updating hook file: $HOOK_FILE"
    :> "$HOOK_FILE"
    chmod 755 "$HOOK_FILE"
    wick-set-config-line "$HOOK_FILE" "/usr/local/bin/set-hostname '$DESIRED'"

    wickInfo "Setting the hostname: $DESIRED"
    /usr/local/bin/set-hostname --verbose "$DESIRED"

    CLOUD_FILE="/etc/cloud/cloud.cfg"
    if [ -f "$CLOUD_FILE" ]; then
        wickInfo "Updating cloud-init: $CLOUD_FILE"
        wick-set-config-line "$CLOUD_FILE" "preserve_hostname: true"
    else
        wickInfo "Cloud-init not detected"
    fi
fi
