#!/usr/bin/env bash

wick-make-user() {
    local ARGS DAEMON_FLAG MOVE_HOME_FLAG NO_SKEL_FLAG PASSWD SET_HOME SET_NAME SET_SHELL SYSTEM_FLAG USERHOME USERNAME

    wickGetOption DAEMON_FLAG daemon "$@"
    wickGetOption SET_HOME home "$@"
    wickGetOption MOVE_HOME_FLAG move-home "$@"
    wickGetOption SET_NAME name "$@"
    wickGetOption NO_SKEL_FLAG no-skel "$@"
    wickGetOption SET_SHELL shell "$@"
    wickGetOption SYSTEM_FLAG system "$@"
    wickGetArgument USERNAME 0 "$@"

    if [[ -z "$USERNAME" ]]; then
        wickError "You must specify a username for wick-make-user"
        return 1
    fi

    # Set reasonable defaults for daemons
    if [[ ! -z "$DAEMON_FLAG" ]]; then
        MOVE_HOME_FLAG=""
        NO_SKEL_FLAG=true
        SET_SHELL=/bin/false
        SYSTEM_FLAG=true
    fi

    PASSWD=$(getent passwd "$USERNAME" || true)

    if [[ -z "$PASSWD" ]]; then
        wickInfo "Creating user: $USERNAME"
        ARGS=(useradd)

        if [[ ! -z "$SET_HOME" ]]; then
            ARGS[${#ARGS[@]}]=-d
            ARGS[${#ARGS[@]}]=$SET_HOME
        fi

        if [[ ! -z "$SET_NAME" ]]; then
            ARGS[${#ARGS[@]}]=-c
            ARGS[${#ARGS[@]}]=$SET_NAME
        fi

        if [[ ! -z "$NO_SKEL_FLAG" ]]; then
            ARGS[${#ARGS[@]}]=-M
        fi

        if [[ ! -z "$SET_SHELL" ]]; then
            ARGS[${#ARGS[@]}]=-s
            ARGS[${#ARGS[@]}]=$SET_SHELL
        fi

        if [[ ! -z "$SYSTEM_FLAG" ]]; then
            ARGS[${#ARGS[@]}]=-r
        fi

        ARGS[${#ARGS[@]}]=$USERNAME
        wickDebug "Command:" "${ARGS[@]}"
        "${ARGS[@]}"
    else
        wickInfo "Altering user: $USERNAME"
        ARGS=(usermod)

        if [[ ! -z "$SET_HOME" ]]; then
            ARGS[${#ARGS[@]}]=-d
            ARGS[${#ARGS[@]}]=$SET_HOME
        fi

        if [[ ! -z "$MOVE_HOME_FLAG" ]]; then
            ARGS[${#ARGS[@]}]=-m
        fi

        if [[ ! -z "$SET_NAME" ]]; then
            ARGS[${#ARGS[@]}]=-c
            ARGS[${#ARGS[@]}]=$SET_NAME
        fi

        if [[ ! -z "$SET_SHELL" ]]; then
            ARGS[${#ARGS[@]}]=-s
            ARGS[${#ARGS[@]}]=$SET_SHELL
        fi

        ARGS[${#ARGS[@]}]=$USERNAME
        wickDebug "Command:" "${ARGS[@]}"
        "${ARGS[@]}"
    fi

    USERHOME=$(getent passwd "$USERNAME" | cut -d : -f 6)
    wick-make-dir --owner="$USERNAME:$USERNAME" --mode=0755 "$USERHOME"
}
