#!/bin/bash

wick-package() {
    local OS STATE UNINSTALL UNPARSED

    wick-get-option EXISTS exists "$@"
    wick-get-option UNINSTALL uninstall "$@"
    wick-get-arguments UNPARSED "$@"

    # Intentionally append to STATE to flag errors
    STATE=""

    if [[ ! -z "$EXISTS" ]]; then
        STATE="exists$STATE"
    fi

    if [[ ! -z "$UNINSTALL" ]]; then
        STATE="uninstall$STATE"
    fi

    : ${STATE:=install}

    wick-explorer OS wick-base os

    case "$OS" in
        centos|redhat)
            wick-package-yum "$STATE" "${UNPARSED[@]-}"
            ;;

        ubuntu|debian)
            wick-package-apt "$STATE" "${UNPARSED[@]-}"
            ;;

        *)
            wick-error "Unable to determine package manager"
            return 1
            ;;
    esac
}

wick-package-yum() {
    local ARGS STATE

    ARGS=()
    STATE=$1
    shift

    case "$STATE" in
        exists)
            if rpm -q "$@" > /dev/null 2>&1; then
                wick-debug "Package exists: $@"
                return 0
            fi

            wick-debug "Package does not exist: $@"
            return 1
            ;;

        install)
            if [[ ! -z "${YUM_ENABLE_REPO-}" ]]; then
                ARGS[${#ARGS[@]}]="--enablerepo=$YUM_ENABLE_REPO"
            fi

            if [[ ${#ARGS[@]} -eq 0 ]]; then
                yum install -y "$@"
            else
                yum "${ARGS[@]}" install -y "$@"
            fi
            ;;

        uninstall)
            yum remove -y "$@"
            ;;

        *)
            echo "Unknown package state: $STATE"
            return 1
    esac
}

wick-package-apt() {
    local STATE

    STATE=$1
    shift

    case "$STATE" in
        exists)
            if apt-cache show "$@" > /dev/null 2>&1; then
                wick-debug "Package exists: $@"
                return 0
            fi

            wick-debug "Package does not exist: $@"
            return 1
            ;;

        install)
            apt-get install -y "$@"
            ;;

        uninstall)
            apt-get purge -y "$@"
            ;;

        *)
            echo "Unknown package state: $STATE"
            return 1
    esac
}
