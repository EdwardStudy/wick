#!/usr/bin/env bash

wickPackage() {
    local OS STATE UNINSTALL UNPARSED

    wickGetOption EXISTS exists "$@"
    wickGetOption UNINSTALL uninstall "$@"
    wickGetArguments UNPARSED "$@"

    # Intentionally append to STATE to flag errors
    STATE=""

    if [[ ! -z "$EXISTS" ]]; then
        STATE="exists$STATE"
    fi

    if [[ ! -z "$UNINSTALL" ]]; then
        STATE="uninstall$STATE"
    fi

    : ${STATE:=install}

    wickExplorer OS wick-base os

    case "$OS" in
        centos|redhat)
            wickPackage-yum "$STATE" "${UNPARSED[@]-}"
            ;;

        ubuntu|debian)
            wickPackage-apt "$STATE" "${UNPARSED[@]-}"
            ;;

        *)
            wickError "Unable to determine package manager"
            return 1
            ;;
    esac
}

wickPackage-yum() {
    local ARGS STATE

    ARGS=()
    STATE=$1
    shift

    case "$STATE" in
        exists)
            if rpm -q "$@" > /dev/null 2>&1; then
                wickDebug "Package exists: $@"
                return 0
            fi

            wickDebug "Package does not exist: $@"
            return 1
            ;;

        install)
            if [[ ! -z "${YUM_ENABLE_REPO-}" ]]; then
                ARGS[${#ARGS[@]}]="--enablerepo=$YUM_ENABLE_REPO"
            fi

            if [[ ${#ARGS[@]} -eq 0 ]]; then
                yum install -y "$@"
            else
                yum "${ARGS[@]}" install -y "$@"
            fi
            ;;

        uninstall)
            yum remove -y "$@"
            ;;

        *)
            echo "Unknown package state: $STATE"
            return 1
    esac
}

wickPackage-apt() {
    local STATE

    STATE=$1
    shift

    case "$STATE" in
        exists)
            if apt-cache show "$@" > /dev/null 2>&1; then
                wickDebug "Package exists: $@"
                return 0
            fi

            wickDebug "Package does not exist: $@"
            return 1
            ;;

        install)
            apt-get install -y "$@"
            ;;

        uninstall)
            apt-get purge -y "$@"
            ;;

        *)
            echo "Unknown package state: $STATE"
            return 1
    esac
}
