#!/bin/bash

wick-on-load wick-add-command provision "Execute the formulas for a given role"

wick-provision() {
    local LOCATION ROLE

    if [[ ${#@} -eq 0 ]]; then
        echo "You must specify one or more roles to provision."

        return 1
    fi

    wick-load-role "${1+"$@"}"

    if [[ ${#WICK_FORMULA_COMMANDS[@]} -eq 0 ]]; then
        echo "No formulas listed or no run scripts found for the formulas."
    else
        wick-provision-formulas
    fi
}


wick-get-formula-run-command() {
    local "$1" && wick-indirect "$1" "$2"
}

wick-provision-formulas() {
    local FORMULA

    # Escaping note:
    # 
    # Formulas in this list are already quoted and must not be quoted if you are
    # to run this properly.  See wick-formula for quoting.
    for FORMULA in "${WICK_FORMULA_COMMANDS[@]}"; do
        echo "Executing formula: $FORMULA"

        # See escaping note above
        wick-get-formula-run-command WICK_FORMULA_DIR $FORMULA
        WICK_FORMULA_DIR=${FORMULA%/*}

        (
            # See escaping note above
            . $FORMULA
        ) || (
            echo "FAILURE DETECTED"
            return 1
        )
    done

    echo "Provisioning complete"
}
