#!/bin/bash
# Enable "strict mode" - see lib/wick-strict-mode for a better version
set -euo pipefail
WICK_DIR="${0%/*}"

CMD="$1"
shift || :

WICK_ON_LOAD_COMMANDS=()

# Test if a given file could be a valid script that should be sourced.
#
# Parameters:
#     $1:  Filename
# Returns true on success
wick-is-valid-script() {
    [[ -f "$1" ]] || return 1
    [[ "${1##*.}" != "md" ]] || return 1
    [[ "$(head -n 1 "$1")" == '#!'* ]] || return 1

    return 0
}


# Load library functions.  Starting at the highest parent, load all
# scripts in lib/, then work down through all children.
#
# Parameters:
#     $1: Directory to process1
wick-load-lib() {
    local FILE

    if [[ -d "$1/parent" ]]; then
        wick-load-lib "$1/parent"
    fi

    if [[ -d "$1/lib" ]]; then
        for FILE in "$1/lib/"*; do
            if wick-is-valid-script "$FILE"; then
                if [[ ! -z "$DEBUG" ]]; then
                    echo "Loading library: $FILE"
                fi

                . "$FILE"
            fi
        done
    fi
}


# Set an on-load hook, which will execute once all of the libraries and
# binaries are loaded into Wick.
#
# Parameters:
#     $*:  Command to execute when everything is loaded
wick-on-load() {
    local ARGS
    wick-argument-string ARGS "$@"
    WICK_ON_LOAD_COMMANDS[${#WICK_ON_LOAD_COMMANDS[@]}]=$ARGS
}


# Load all library functions
wick-load-lib "."

# Enable the full strict mode
wick-strict-mode

# Load all functions into the current environment
for F in "$WICK_DIR/"wick-*; do
    if [[ -f "$F" ]]; then
        . "$F"
    fi
done

# Run all initialization functions
if [[ ${#WICK_ON_LOAD_COMMANDS[@]} -gt 0 ]]; then
    for LINE in "${WICK_ON_LOAD_COMMANDS[@]}"; do
        eval "$LINE"
    done
fi

# If no command specified, show the help message
if [[ -z "$CMD" ]]; then
    CMD="help"
fi

# Check if we have the listed command
if [[ "${#WICK_COMMANDS[@]}" -eq 0 ]]; then
    echo "No commands loaded."
elif ! wick-in-array "$CMD" "${WICK_COMMANDS[@]}"; then
    echo "No such command: $CMD"
    echo "See 'wick help'"
else
    wick-$CMD "$@"
fi
