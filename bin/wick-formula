#!/bin/bash

WICK_FORMULA_LIST=()
WIck_FORMULA_LIST_WITH_ARGS=()
WICK_FORMULA_COMMANDS=()

wick-formula() {
    local ARGS FILE FORMULA FORMULA_ESCAPED LOCATION PRESERVED_PWD TEMP

    FORMULA="$1"
    wick-argument-string FORMULA_ESCAPED "$FORMULA"
    shift

    if [[ $# -gt 0 ]]; then
        wick-argument-string ARGS "$@"
        ARGS=" $ARGS"
    else
        ARGS=""
    fi

    if [[ -z "$FORMULA" ]]; then
        echo "You must specify a formula name." >&2

        return 1
    fi

    if ! wick-find LOCATION "formulas/$FORMULA"; then
        echo "Unable to find formula $FORMULA" >&2

        return 1
    fi

    if wick-in-array "$FORMULA" "${WICK_FORMULA_LIST[@]}"; then
        # Specifying the same formula is ok as long as the arguments are the same
        if wick-in-array "$FORMULA_ESCAPED$ARGS" "${WICK_FORMULA_LIST_WITH_ARGS[@]}"; then
            echo "Formula is already in list: $FORMULA"
            return 0
        fi

        # You can add the formula as a dependency with no arguments when it
        # was already added with arguments
        if [[ "$ARGS" == "" ]]; then
            echo "Formula is already in list and has additional arguments: $FORMULA"
            return 0
        fi

        # Mismatched arguments OR previously did not have arguments and current
        # one has arguments.  Do not continue.
        echo "Formula specified multiple times with different arguments: $FORMULA" >&2
        return 1
    fi

    echo "Adding formula $FORMULA ($LOCATION)"
    WICK_FORMULA_LIST=("${WICK_FORMULA_LIST[@]}" "$FORMULA")
    WICK_FORMULA_LIST_WITH_ARGS=("${WICK_FORMULA_LIST_WITH_ARGS[@]}" "$FORMULA_ESCAPED$ARGS")

    if [[ -f "$LOCATION/depends" ]]; then
        WICK_FORMULA_DIR=$LOCATION
        PRESERVED_PWD=$PWD
        . "$LOCATION/depends"
        cd "$PRESERVED_PWD"
    fi

    if [[ -f "$LOCATION/run" ]]; then
        wick-argument-string TEMP "$LOCATION/run"
        WICK_FORMULA_COMMANDS=("${WICK_FORMULA_COMMANDS[@]}" "$TEMP$ARGS")
    fi

    if [[ -d "$LOCATION/functions" ]]; then
        for FILE in "$LOCATION/functions/"*; do
            if [[ -f "$FILE" ]]; then
                echo "Loading function: $FILE"
                . "$FILE"
            fi
        done
    fi

    if [[ -d "$LOCATION/explorers" ]]; then
        for FILE in "$LOCATION/explorers/"*; do
            if [[ -f "$FILE" ]]; then
                echo "Running explorer: $FILE"
                (
                    wick-explorer TEMP "$FORMULA" "${FILE##*/}"
                )
            fi
        done
    fi
}
