#!/bin/bash
#
# Run explorers on the target machine

# Run an explorer
#
# Parameters:
#     $1:  Variable name for the result
#     $2:  Formula name
#     $3:  Explorer name
# Returns true when explorer ran successfully, false otherwise
wick-explorer() {
    local EXPLORER TEMP

    EXPLORER="formulas/$2/explorers/$3"

    if ! wick-find EXPLORER "$EXPLORER"; then
        wick-error "Unable to find explorer: $EXPLORER"

        return 1
    fi

    # Run the explorer
    wick-temp-dir TEMP

    (
        . "$EXPLORER" > "$TEMP/stdout" 2> "$TEMP/stderr" || echo "$" > "$TEMP/fail"
    )

    if [[ -f "$TEMP/fail" ]]; then
        wick-error "Explorer failed: $EXPLORER"
        wick-error "Status code:  $(<"$TEMP/fail")"

        return 1
    fi

    wick-debug "Explorer success"
    wick-debug "$(<"$TEMP/stdout")"

    local "$1" && wick-indirect "$1" "$(<"$TEMP/stdout")"
}
